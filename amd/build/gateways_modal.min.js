define(["exports","core/ajax","core/templates","core/modal","core/modal_events","core/str","core/notification"],function(e,t,r,n,o,a,s){"use strict";function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=c(t),d=c(r),u=c(n),l=c(o),m=c(s);const h=(e,t,r)=>i.default.call([{methodname:"paygw_authorizedotnet_get_config_for_js",args:{component:e,paymentarea:t,itemid:r}}])[0],p=(e,t,r)=>i.default.call([{methodname:"paygw_authorizedotnet_get_merchant_currency",args:{component:e,paymentarea:t,itemid:r}}])[0],g=e=>{const t="sandbox"===e?"https://jstest.authorize.net/v3/AcceptUI.js":"https://js.authorize.net/v3/AcceptUI.js";if(g.currentlyloaded===t)return Promise.resolve();if(g.currentlyloaded){const e=document.querySelector(`script[src="${g.currentlyloaded}"]`);e&&e.parentNode.removeChild(e)}const r=document.createElement("script");return new Promise(e=>{r.readyState?r.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||(this.onreadystatechange=null,e())}:r.onload=function(){e()},r.setAttribute("src",t),r.setAttribute("charset","utf-8"),document.head.appendChild(r),g.currentlyloaded=t})};g.currentlyloaded="",e.process=(e,t,r,n)=>{let o;return Promise.all([h(e,t,r),p(e,t,r)]).then(([e,t])=>t.success&&t.currency===e.currency?d.default.render("paygw_authorizedotnet/authorizedotnet_button",{apiloginid:e.apiloginid,clientkey:e.publicclientkey}).then(async e=>u.default.create({title:a.getString("pluginname","paygw_authorizedotnet"),body:e,show:!0,removeOnClose:!0})).then(t=>(o=t,g(e.environment))):Promise.reject(new Error("Currency mismatch. Merchant supports "+t.currency+" but this transaction is in "+e.currency+"."))).then(()=>new Promise(n=>{window.responseHandler=function(s){if(o.getRoot().on(l.default.outsideClick,e=>{e.preventDefault()}),"Error"===s.messages.resultCode){let e="";for(let t=0;t<s.messages.message.length;t++)e+=s.messages.message[t].text+"\n";return void m.default.alert(a.getString("error","moodle"),e)}o.setBody(a.getString("authorising","paygw_authorizedotnet")),((e,t,r,n)=>i.default.call([{methodname:"paygw_authorizedotnet_process_payment",args:{component:e,paymentarea:t,itemid:r,opaquedata:JSON.stringify(n)}}])[0])(e,t,r,s.opaqueData).then(e=>(o.hide(),e)).then(n)}})).then(e=>e.success?Promise.resolve(e.message):Promise.reject(e.message)).catch(e=>(m.default.alert(a.getString("error","moodle"),e.message||"An unknown error occurred."),Promise.reject(e.message)))},Object.defineProperty(e,"__esModule",{value:!0})});
